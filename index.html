<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tool xuất file excel nhập kho Kiotviet</title>
  <style>
    body{font-family: Arial, Helvetica, sans-serif; padding:18px; background:#f7f7f7}
    h1{font-size:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{display:block;font-size:12px;margin-bottom:4px}
    input,select,textarea{padding:6px;border:1px solid #ccc;border-radius:4px}
    .btn{padding:8px 12px;border-radius:6px;border:0;background:#2b78e4;color:#fff;cursor:pointer}
    .btn.ghost{background:#777}
    .table-wrapper{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;min-width:1200px}
    th,td{padding:8px;border:1px solid #e2e2e2;font-size:13px;white-space:nowrap}
  </style>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Form xuất file excel nhập kho Kiotviet</h1>
  <p>Điền thông tin, bấm <strong>Thêm hàng</strong> để thêm dòng, sau đó <strong>Xuất Excel</strong>.</p>

  <div style="background:#fff;padding:12px;border-radius:6px;margin-bottom:12px;">
    <div class="row">
      <div style="min-width:220px">
        <label>Loại hàng</label>
        <select id="loai_hang">
          <option>Hàng hoá</option>
        </select>
      </div>

      <div style="min-width:260px">
        <label>Nhóm hàng (3 Cấp)</label>
        <select id="nhom_hang">
          <option value="phuquy">Bạc tích trữ - Phú Quý</option>
          <option value="ancarat">Bạc tích trữ - Ancarat</option>
        </select>
      </div>

      <div style="min-width:160px">
        <label>Số bắt đầu cho Mã hàng (ví dụ 238)</label>
        <input id="start_number" type="number" value="238" />
      </div>

      <div style="min-width:180px">
        <label>Giá vốn (mặc định nhập)</label>
        <input id="default_giavon" type="number" value="0" />
      </div>

      <div style="min-width:160px">
        <label>Tồn kho mặc định</label>
        <input id="default_tonkho" type="number" value="0" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <button class="btn" id="addRowBtn">Thêm hàng</button>
        <button class="btn ghost" id="clearBtn">Xoá bảng</button>
        <button class="btn" id="exportBtn">Xuất Excel</button>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
  <table id="grid">
    <thead>
      <tr>
        <th>#</th>
        <th>Loại hàng</th>
        <th>Nhóm hàng</th>
        <th>Mã hàng</th>
        <th>Tên hàng</th>
        <th>Thương hiệu</th>
        <th>Giá bán</th>
        <th>Giá vốn</th>
        <th>Tồn kho</th>
        <th>Dự kiến hết hàng</th>
        <th>Tồn nhỏ nhất</th>
        <th>Tồn lớn nhất</th>
        <th>ĐVT</th>
        <th>Mã ĐVT Cơ bản</th>
        <th>Quy đổi</th>
        <th>Thuộc tính</th>
        <th>Mã HH liên quan</th>
        <th>Hình ảnh (url1,url2...)</th>
        <th>Trọng lượng</th>
        <th>Đang kinh doanh</th>
        <th>Được bán trực tiếp</th>
        <th>Mô tả</th>
        <th>Mẫu ghi chú</th>
        <th>Vị trí</th>
        <th>Hàng thành phần</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  </div>

<script>
  function formatSKU(n){
    const num = parseInt(n||0,10);
    const s = String(num).padStart(6,'0');
    return 'SP' + s;
  }

  // Mapping ĐVT cố định cho Phú Quý
  const dvtPhuQuy = {
    'Bạc kỷ niệm 80 năm Quốc khánh 999 5L': '5 Lượng',
    'Bạc Thanh Long Phú Quý 999 1L': 'Lượng',
    'Bạc miếng Phú Quý 999 1L': 'Lượng',
    'Bạc Thanh Long Phú Quý 999 5L': '5 Lượng',
    'Bạc thỏi Phú Quý 999 5L': '5 Lượng',
    'Bạc thỏi Phú Quý 999 10L': '10 Lượng',
    'Bạc Thanh Long Phú Quý 999 1KG': 'Kg',
    'Bạc thỏi Phú Quý 999 1KG': 'Kg',
    'Bạch Ngân Đại Cát 1 lượng': 'Lượng',
    'Đồng bạc Bát Bảo Cát Tường Phú Quý 5 chỉ': '5 Chỉ',
    'Đồng bạc Liên Hoa Bồ Đề Phú Quý 1 Lượng': '10 Chỉ',
    'Đồng bạc Buffalo Matte 1 OZ Phú Quý (Bản mờ)': '8.3 Chỉ',
    'Đồng bạc Buffalo Proof 1 OZ Phú Quý (Bản bóng)': '8.3 Chỉ',
    'Đồng Bạc Britannia Charles III 1 OZ 2024': '8.3 Chỉ',
    'Đồng Bạc Kangaroo 1 OZ 2024': '8.3 Chỉ',
    'Đồng Bạc Maple Leaf 1 OZ 2024': '8.3 Chỉ',
    'Đồng Bạc American Eagle 1 OZ 2024': '8.3 Chỉ',
    'Đồng Bạc Dragon III 1 OZ 2024': '8.3 Chỉ',
    'Đồng Bạc Dragon Colour III 2024 1 OZ': '8.3 Chỉ',
    'Đồng Bạc Panda 30g 2024': '8.3 Chỉ'
  };

  const nhomSelect = document.getElementById('nhom_hang');
  const startNumberInput = document.getElementById('start_number');
  const defaultGiavon = document.getElementById('default_giavon');
  const defaultTonkho = document.getElementById('default_tonkho');
  const tbody = document.getElementById('tbody');
  let counter = 0;

  function brandForGroup(val){
    if(val === 'phuquy') return 'Phú Quý';
    if(val === 'ancarat') return 'Ancarat';
    return '';
  }

  function namesForBrand(brand){
    if(brand === 'Phú Quý') return Object.keys(dvtPhuQuy);
    if(brand === 'Ancarat') return [
      'Bạc miếng Ancarat 999 - 1 lượng',
      'Bạc miếng 2024 Ancarat 999 - 5 lượng',
      'Bạc thỏi 2025 Ancarat 999 - 500 gram',
      'Bitcoin 999 - xu 1 lượng',
      "Mother's Day 999 - miếng 5 chỉ"
    ];
    return [];
  }

  function dvtsForBrand(brand){
    if(brand === 'Phú Quý') return []; // auto theo mapping
    if(brand === 'Ancarat') return ['Miếng','Thỏi','Xu'];
    return [];
  }

  function addRow(){
    counter += 1;
    const nhom = nhomSelect.value;
    const brand = brandForGroup(nhom);
    const startNum = parseInt(startNumberInput.value||0,10) + counter - 1;
    const sku = formatSKU(startNum);

    const tr = document.createElement('tr');
    const products = namesForBrand(brand);

    tr.innerHTML = `
      <td>${counter}</td>
      <td><input value="Hàng hoá"/></td>
      <td><input value="${nhom === 'phuquy' ? 'Bạc tích trữ - Phú Quý' : 'Bạc tích trữ - Ancarat'}"/></td>
      <td><input class="sku" value="${sku}"/></td>
      <td>
        <select class="ten_hang">
          ${products.map(n=>`<option>${n}</option>`).join('')}
        </select>
      </td>
      <td><input class="thuong_hieu" value="${brand}" readonly/></td>
      <td><input class="gia_ban" type="number" value="0"/></td>
      <td><input class="gia_von" type="number" value="${defaultGiavon.value || 0}"/></td>
      <td><input class="ton_kho" type="number" value="${defaultTonkho.value || 0}"/></td>
      <td><input class="du_kien_het_hang" value="--"/></td>
      <td><input class="ton_nho_nhat" type="number" value="0"/></td>
      <td><input class="ton_lon_nhat" type="number" value="999999999"/></td>
      <td class="dvt_cell"></td>
      <td><input class="ma_dvt" value=""/></td>
      <td><input class="quy_doi" type="number" value="1"/></td>
      <td><input class="thuoc_tinh" value=""/></td>
      <td><input class="ma_hh_lien_quan" value=""/></td>
      <td><input class="hinh_anh" value=""/></td>
      <td><input class="trong_luong" value=""/></td>
      <td><input class="dang_kinh_doanh" value="1"/></td>
      <td><input class="duoc_ban_truc_tiep" value="1"/></td>
      <td><input class="mo_ta" value=""/></td>
      <td><input class="mau_ghi_chu" value=""/></td>
      <td><input class="vi_tri" value=""/></td>
      <td><input class="hang_thanh_phan" value=""/></td>
      <td><button onclick="removeRow(this)">Xoá</button></td>
    `;
    tbody.appendChild(tr);

    const tenHangSelect = tr.querySelector('.ten_hang');
    const dvtCell = tr.querySelector('.dvt_cell');

    function updateDVT(){
      if(brand==="Phú Quý"){
        const val = tenHangSelect.value;
        dvtCell.innerHTML = `<input class="dvt" value="${dvtPhuQuy[val]||''}" readonly/>`;
      }else{
        dvtCell.innerHTML = `<select class="dvt">${dvtsForBrand(brand).map(d=>`<option>${d}</option>`).join('')}</select>`;
      }
    }
    tenHangSelect.addEventListener('change', updateDVT);
    updateDVT();
  }

  function removeRow(btn){
    const tr = btn.closest('tr');
    tr.remove();
    [...tbody.children].forEach((r,i)=> r.cells[0].innerText = i+1);
    counter = tbody.children.length;
  }

  document.getElementById('addRowBtn').addEventListener('click', addRow);
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    tbody.innerHTML = '';
    counter = 0;
  });

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    if(tbody.children.length === 0){ alert('Không có dữ liệu để xuất.'); return; }

    const headers = [
      'Loại hàng','Nhóm hàng','Mã hàng','Tên hàng','Thương hiệu','Giá bán','Giá vốn','Tồn kho','Dự kiến hết hàng','Tồn nhỏ nhất','Tồn lớn nhất','ĐVT','Mã ĐVT Cơ bản','Quy đổi','Thuộc tính','Mã HH liên quan','Hình ảnh (url1,url2...)','Trọng lượng','Đang kinh doanh','Được bán trực tiếp','Mô tả','Mẫu ghi chú','Vị trí','Hàng thành phần'
    ];

    const data = [headers];

    for(const tr of tbody.children){
      const cells = tr.querySelectorAll('input,select');
      const row = [
        cells[0].value,
        cells[1].value,
        cells[2].value,
        cells[3].value,
        cells[4].value,
        cells[5].value,
        cells[6].value,
        cells[7].value,
        cells[8].value,
        cells[9].value,
        cells[10].value,
        (tr.querySelector('.dvt') ? tr.querySelector('.dvt').value : ''),
        tr.querySelector('.ma_dvt').value,
        tr.querySelector('.quy_doi').value,
        tr.querySelector('.thuoc_tinh').value,
        tr.querySelector('.ma_hh_lien_quan').value,
        tr.querySelector('.hinh_anh').value,
        tr.querySelector('.trong_luong').value,
        tr.querySelector('.dang_kinh_doanh').value,
        tr.querySelector('.duoc_ban_truc_tiep').value,
        tr.querySelector('.mo_ta').value,
        tr.querySelector('.mau_ghi_chu').value,
        tr.querySelector('.vi_tri').value,
        tr.querySelector('.hang_thanh_phan').value
      ];
      data.push(row);
    }

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
    XLSX.writeFile(wb, "phuquyancarat.xlsx");
  });

  addRow();
</script>
</body>
</html>
